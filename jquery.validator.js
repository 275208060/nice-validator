/*! nice Validator 0.3.0
 * (c) 2012-2013 Jony Zhang <zj86@live.cn>, MIT Licensed
 * http://niceue.com/validator/
 */
!function(e,t){"use strict";function i(s,a){var l,u,o=this;return!o instanceof i?new i(s,a):(j(a)&&(a={success:a}),a=a||{},u=P(s,"data-"+m+"-option"),u=u&&"{"===u.charAt(0)?Function("return "+u)():{},l=J[a.theme||u.theme||B.theme],o.options=e.extend({},B,l,u,a),o.$el=e(s),o.rules=new n(o.options.rules,!0),o.messages=new r(o.options.messages,!0),o.fields={},o.elements={},o.isValid=!0,o.deferreds={},o._init(),t)}function n(e,t){var i=t?t===!0?this:t:n.prototype;if(I(e))for(var r in e)i[r]=s(e[r])}function r(e,t){var i=t?t===!0?this:t:r.prototype;if(I(e))for(var n in e){if(!e[n])return;i[n]=e[n]}}function s(t){switch(e.type(t)){case"function":return t;case"array":return function(e){return t[0].test(e.value)||t[1]||!1};case"regexp":return function(e){return t.test(e.value)}}}function a(t){var i="";return e.map(t.split(" "),function(e){i+=","+("#"===e.charAt(0)?e:'[name="'+e+'"]')}),i.substring(1)}function l(t){if(t&&t.tagName){var i=t;switch(t.tagName){case"INPUT":case"SELECT":case"TEXTAREA":i=t.form||e(t).closest(".n-"+m);break;default:i=e(t).closest(".n-"+m)}return e(i).data(m)||e(i)[m]().data(m)}}function u(i,n){var r=e.trim(P(i,O+"-"+n));if(r)return r=Function("return "+r)(),r?s(r):t}function o(e,t,i){var n=t.msg;return I(n)&&i&&(n=n[i]),D(n)||(n=P(e,"data-msg-"+i)||P(e,"data-msg")||""),n}function c(e){if(!e)return"";var t=R.exec(e);return t?t[1]:""}function d(e){return(e||B.msgTemplate).replace("{#msg}",A)}function f(t,i,n){var r,s,a,l,u=e(t);if(u.is(":input")?(l=i.target||P(t,x),l&&(l=e(l,n),l.length&&(l.is(":input")?t=l.get(0):r=l)),s=t.name||"#"+t.id,r=r||e("."+_+'[data-for="'+s+'"]',n)):r=u,!r.length)if(u=e(l||t,n),a=d(i.tpl),r=e(a).addClass(_).attr({style:i.style||"","data-for":s}),i.cls&&r.addClass(i.cls),u.is(":checkbox,:radio")){var o=u.parent();r.appendTo(o.is("label")?o.parent():o)}else r[i.pos&&"right"!==i.pos?"insertBefore":"insertAfter"](u);return r}function g(t,i,n){var r,s,a;r={error:v,ok:p,tip:y,loading:k}[i.type||(i.type="error")],s=f(t,i,n),a=s.find("span.msg-wrap"),a.length||(a=e(A).appendTo(s)),L&&-1!==s[0].className.indexOf("bottom")&&(s[0].style.marginTop=e(t).outerHeight()+"px"),a[0].innerHTML=(i.arrow||"")+(i.icon||"")+'<span class="n-msg">'+i.msg+"</span>",a[0].className="msg-wrap "+r,s[0].style.display="",j(i.show)&&i.show(a,i.type)}function h(e,t,i){t=t||{};var n=f(e,t,i);n.length&&(j(t.hide)?(n[0].style.display="",t.hide(n.find("span.msg-wrap"),t.type)):n[0].style.display="none")}var m="validator",p="n-ok",v="n-error",y="n-tip",k="n-loading",b="n-invalid",_="msg-box",w="aria-invalid",O="data-rule",x="data-target",M="data-tip",$="data-inputstatus",V=":input:not(:button,:submit,:reset,:disabled)",A='<span class="msg-wrap" role="alert"></span>',C=/(\w+)(?:[\[\(]([^\]\)]*)[\]\)])?/,T=/(?:([^:\[]*):)?\s*(.*)/,F=/[^\x00-\xff]/g,R=/^.*(top|right|bottom|left).*$/,E=/(?:(post|get):)?(.+)/i,q=/<|>|&lt;|&gt;/g,H=e.noop,S=e.proxy,j=e.isFunction,N=e.isArray,D=function(e){return"string"==typeof e},I=function(e){return e&&"[object Object]"===Object.prototype.toString.call(e)},L=!window.XMLHttpRequest,P=function(e,i,n){return n===t?e.getAttribute(i):(null===n?e.removeAttribute(i):e.setAttribute(i,""+n),t)},X=window.console||{log:H,info:H,warn:H},B={debug:0,timely:1,theme:"default",stopOnError:!0,ignore:"",valid:H,invalid:H,msgTemplate:"<span>{#msg}</span>",msgIcon:'<span class="n-icon"></span>',msgArrow:"",msgClass:"",defaultMsg:"{0} is not valid.",loadingMsg:"Validating..."},J={"default":{formClass:"n-default",msgClass:"n-right",showOk:""}};e.fn[m]=function(t){var n=this,r=arguments;return n.is(":input")?n:(!n.is("form")&&(n=this.find("form")),!n.length&&(n=this),n.each(function(){if(D(t)){if("_"===t.charAt(0))return;var n=e(this).data(m);n&&n[t].apply(n,Array.prototype.slice.call(r,1))}else new i(this,t)}),this)},e.fn.isValid=function(e,t){var i,n=l(this[0]);return n?(n.checkOnly=t,i=this.is(":input")?this:this.find(V),n._multiValidate(i,function(t){n.checkOnly=!1,j(e)&&e.call(null,t)})):!0},i.prototype={_init:function(){var i=this,n=i.options,r=i.fields;N(n.groups)&&e.map(n.groups,function(t){if(!D(t.fields)||!j(t.callback))return null;var n=e(a(t.fields),i.$el),s=function(){return t.callback.call(i,n)};e.extend(s,t),e.map(t.fields.split(" "),function(e){r[e]=r[e]||{},r[e].group=s})}),I(n.fields)&&e.each(n.fields,function(e,t){t&&(r[e]=D(t)?{rule:t}:t)}),e(V,i.$el).each(function(){var e,s=this,a=s.id;return a&&"#"+a in r||(a=s.name),a?(e=r[a]||{},e.rule||(e.rule=P(s,O)||""),e.rules=[],P(s,O,null),e.rule&&(e.name=e.name||s.name,e.key=a,e.required=-1!==e.rule.indexOf("required"),e.must=-1!==e.rule.indexOf("match")||-1!==e.rule.indexOf("checked"),e.required&&P(s,"aria-required",!0),("timely"in e&&!e.timely||!n.timely)&&P(s,"notimely",!0),D(e.target)&&P(s,x,e.target),D(e.tip)&&P(s,M,e.tip),r[a]=i._parseField(e)),t):P(s,O,null)}),i.msgOpt={type:"error",tpl:d(n.msgTemplate),pos:c(n.msgClass),cls:n.msgClass,icon:n.msgIcon,arrow:n.msgArrow,style:n.msgStyle,show:n.msgShow,hide:n.msgHide},i.$el.data(m)||(i.$el.on("submit",S(i,"_submit")).on("click",":submit",S(i,"_clickSubmit")).on("reset",S(i,"_reset")).on("validated.field",V,S(i,"_validatedField")).on("validated.rule",V,S(i,"_validatedRule")).on("focusout validate",V,S(i,"_blur")).on("click",":radio,:checkbox",S(i,"_click")),n.msgHandler||i.$el.on("focusin",V,S(i,"_focus")),2===n.timely&&i.$el.on("keyup",V,S(i,"_blur")).on("change","select",S(i,"_click")),i.$el.data(m,i).addClass("n-"+m+" "+n.formClass),P(i.$el[0],"novalidate","true"))},_multiValidate:function(i,n){var r=this,s="focus.field",a=r.options;return a.ignore&&(i=i.not(a.ignore)),r.isValid=!0,i.each(function(i,n){if(!e(n).is("[novalidate]")){var l=r.getField(this);if(l)return r._validate(this,l),!r.isValid&&a.stopOnError?(r.submiting&&!r.checkOnly&&e(this).trigger(s).trigger(s),!1):t}}),n&&e.when.apply(null,e.map(r.deferreds,function(e){return e})).done(function(){setTimeout(function(){if(n.call(null,r.isValid),j(a.msgHandler)){var t=[];e.map(r.fields,function(e){e.errorMsg&&t.push(e.errorMsg)}),a.msgHandler.call(r,t)}},1)}),e.isEmptyObject(r.deferreds)?r.isValid:t},_clickSubmit:function(e){e.form=e.target.form,e.preventDefault(),this._submit(e)},_submit:function(t){var i,n=this,r=n.options,s=t.form||t.target,a="focus.field",l=e(V,n.$el);return n._reset(),n.submiting=!0,n._multiValidate(l,function(l){t.form?l&&t.form.submit():l||r.stopOnError||n.checkOnly||e(":input."+b+":first",n.$el).trigger(a).trigger(a),i=l||2===r.debug?"valid":"invalid",r[i].call(n,s),n.$el.trigger(i+".form",[s]),n.submiting=!1}),n.isValid&&(P(s,"action")||t.form)||t.preventDefault(),n.isValid},_reset:function(){var t=this;t.options.msgHandler||(e("[data-for]."+_,t.$el).map(function(){this.style.display="none"}),e(V,t.$el).map(function(){P(this,$,null),P(this,w,null),e(this).removeClass(b)})),t._clearCache(),t.isValid=!0},_clearCache:function(){e.map(this.fields,function(e){e.old={}})},_focus:function(e){var t=e.target;this.submiting||""!==t.value&&("false"===P(t,w)||"tip"===P(t,$))||this.showMsg(t,{msg:P(t,M),type:"tip"})},_blur:function(t,i){var n,r,s=this,a=s.options,l=t.target,u=100;if(!i){if("validate"===t.type)r=!0;else{if(e(l).is("[notimely]"))return;if(2===a.timely&&"keyup"!==t.type)return}if(a.ignore&&e(l).is(a.ignore))return;if("keyup"===t.type){var o=t.keyCode,c={8:1,9:1,16:1,32:1,46:1};if(48>o&&!c[o])return;u=500}}n=s.getField(l),n&&(n.timeout&&clearTimeout(n.timeout),n.timeout=setTimeout(function(){s._validate(l,n,r)},u))},_click:function(e){this._blur(e,!0)},_parseField:function(i){var n,r=T.exec(i.rule);if(r)return i.display=r[1],n=(r[2]||"").split(";"),e.map(n,function(n){var r=C.exec(n);return r?(i.rules.push({method:r[1],params:r[2]?e.trim(r[2]).split(", "):t}),t):null}),i.vid=0,i.rid=i.rules[0].method,i},_validatedField:function(t,i,n){var r=this,s=r.options,a=t.target,l=i.isValid=!!n.valid;l&&(n.type="ok"),e(a)[l?"removeClass":"addClass"](b).trigger((l?"valid":"invalid")+".field",[i,n]).attr(w,!l),i.old.ret=n,r.elements[i.key]=a,s.msgHandler?i.errorMsg=l?"":n.msg:r.checkOnly||(!n.showOk&&n.msg||n.showOk&&s.showOk!==!1?r.showMsg(a,n):r.hideMsg(a,n))},_validatedRule:function(i,n,r,s){r=r||a.getField(u);var a=this,l=a.options,u=i.target,c="",d=r.rid,f=!1,g=!1;if(s=s||{},n!==!0?(c=o(u,r,d),c||(D(n)?(c=n,n={error:c}):I(n)&&(n.error?c=n.error:(f=!0,n.ok&&D(n.ok)&&(g=!0),c=n.ok))),s.msg=(f?c:c||a.messages[d]||B.defaultMsg).replace("{0}",r.display||"")):f=!0,f){if(s.valid=!0,!g){var h=r.ok||P(u,"data-ok");h?(g=!0,s.msg=h):D(l.showOk)&&(g=!0,s.msg=l.showOk)}s.showOk=g,e(u).trigger("valid.rule",[d])}else a.isValid=!1,e(u).trigger("invalid.rule",[d]);l.debug&&X[f?"info":"warn"](r.vid+": "+d+" -> "+(s.msg||!0)),f&&r.old.value!==t&&r.old.value!==u.value?(r.vid=0,a._checkRule(u,r)):f&&r.vid<r.rules.length-1?(r.vid++,a._checkRule(u,r)):(r.vid=0,e(u).trigger("validated.field",[r,s]))},_checkRule:function(i,n){var r,s=this,a=n.rules[n.vid],l=a.method,o=a.params;if(n.rid=l,n.old.value=i.value,r=(u(i,l)||s.rules[l]||function(){return!0}).call(s,i,o,n),I(r)&&j(r.then)){var c=function(e){return D(e)||I(e)&&("error"in e||"ok"in e)?e:t};s.deferreds[n.key]=r,!s.checkOnly&&s.showMsg(i,{type:"loading",msg:s.options.loadingMsg}),r.then(function(r,s,a){var l,u=a.responseText;""===u?u=!0:"{"===u.charAt(0)&&(u=e.parseJSON(u)||{},l=c(u),l===t&&(l=c(u.data)),u=l||!0),e(i).trigger("validated.rule",[u,n])},function(t,r){e(i).trigger("validated.rule",[r,n])}).always(function(){delete s.deferreds[n.key]}),n.isValid=t}else e(i).trigger("validated.rule",[r,n])},_checkField:function(e,t){return(t=t||this.getField(e))?(this._validate(e,t,!0),t.isValid):!0},_validate:function(i,n,r){var s,a,l=this,u=l.options,o=e(i),c={},d=n.group,f=P(i,$),g=n.isValid=!0;if(n&&n.rules&&!i.disabled&&!o.is("[novalidate]")){if(s=n.old=n.old||{},r=r||n.must,d&&(e.extend(c,d),a=d.call(l),a!==!0?(D(a)&&(a={error:a}),n.vid=0,n.rid="group",g=!1):(a=t,l.hideMsg(i,c))),g&&!n.required&&""===i.value){if("tip"===f)return;if(l._focus({target:i}),s.value="",!o.is(":checkbox,:radio"))return o.trigger("validated.field",[n,{valid:!0}]),t}else if(!r&&s&&s.ret!==t&&s.value===i.value){if(s.ret.valid||(g=l.isValid=!1),"tip"===f)return;if(""!==i.value)return c=s.ret,o.trigger("validated.field",[n,c]),t}u.debug&&X.log(i),a!==t?o.trigger("validated.rule",[a,n,c]):n.rule&&l._checkRule(i,n)}},getField:function(e){var t,i=this;return t=e.id&&"#"+e.id in i.fields||!e.name?"#"+e.id:e.name,i.fields[t]},test:function(i,n){var r,s,a,l=this,u=C.exec(n);return u?(s=u[1],a=u[2]?e.trim(u[2]).split(", "):t,s in l.rules&&(r=l.rules[s].call(l,i,a)),r===!0||r===t||r):!0},getRangeMsg:function(e,t,i,n){if(t){var r=this,s=r.messages[i]||"",a=t[0].split("~"),l=a[0],u=a[1],o="rg",c=[""],d=+e===+e;if(2===a.length){if(l&&u){if(d&&e>=+l&&+u>=e)return!0;c=c.concat(a)}else if(l&&!u){if(d&&e>=+l)return!0;c.push(l),o="gt"}else if(!l&&u){if(d&&+u>=e)return!0;c.push(u),o="lt"}}else{if(e===+l)return!0;c.push(l),o="eq"}return s&&(n&&n+o in s&&(o=n+o),c[0]=s[o]),r.renderMsg.apply(null,c)}},_getMsgOpt:function(t){return e.extend({},this.msgOpt,D(t)?{msg:t}:t)},renderMsg:function(){var e=arguments,t=e[0],i=e.length;if(t){for(;--i;)t=t.replace("{"+i+"}",e[i]);return t}},showMsg:function(t,i){i=this._getMsgOpt(i),(i.msg||i.showOk)&&(t=e(t).get(0),P(t,$,i.type),g(t,i,this.$el))},hideMsg:function(t,i){i=this._getMsgOpt(i),h(e(t).get(0),i,this.$el)},mapMsg:function(t){var i=this;e.each(t,function(t,n){var r=i.elements[t]||e(':input[name="'+t+'"]',i.$el)[0];i.showMsg(r,n)})},setMsg:function(e){new r(e,this.messages)},setRule:function(e){this._clearCache(),new n(e,this.rules)},setField:function(i,n){var r=this,s={};if(D(i)){if(null===n)return e.map(i.split(" "),function(e){e&&r.fields[e]&&(r.fields[e]=null)}),t;n&&(s[i]=n)}else I(i)&&(s=i);e.extend(!0,r.options.fields,s),r._init()},destroy:function(){this.$el.trigger("reset").off().removeData(m)}},e(function(){e("body").on("focusin",":input["+O+"]",function(){l(this)?e(this).trigger("focusin"):e(this).removeAttr(O)}).on("click submit","form:not([novalidate])",function(t){var i,n=e(this);n.data(m)||(i=n[m]().data(m),e.isEmptyObject(i.fields)?n.attr("novalidate",!0).removeData(m):"submit"===t.type&&i._submit(t))})}),new n({required:function(t){return!!e.trim(t.value)},integer:function(e,t){var i,n="0|",r="[1-9]\\d*",s=t?t[0]:"*";switch(s){case"+":i=r;break;case"-":i="-"+r;break;case"+0":i=n+r;break;case"-0":i=n+"-"+r;break;default:i=n+"-?"+r}return i="^(?:"+i+")$",RegExp(i).test(e.value)||this.messages.integer[s]},match:function(t,i,n){var r,s,a,l,u,o=t.value,c="eq";if(i&&(1===i.length?s=i[0]:(c=i[0],s=i[1]),l=e("#"===s.charAt(0)?s:':input[name="'+s+'"]',this.$el)[0]))switch(n.init_match||(this.$el.on("valid.field",'[name="'+s+'"]',function(){t.value&&e(t).trigger("validate")}),n.init_match=!0),u=this.getField(l),a=this.messages.match[c].replace("{1}",u.display||s),r=l.value,c){case"lt":return+r>+o||a;case"lte":return+r>=+o||a;case"gte":return+o>=+r||a;case"gt":return+o>+r||a;default:return o===r||a}},range:function(e,t){return this.getRangeMsg(+e.value,t,"range")},checked:function(t,i){if(!e(t).is(":radio,:checkbox"))return!0;var n=e('input[name="'+t.name+'"]',this.$el).filter(function(){return!this.disabled&&this.checked&&e(this).is(":visible")}).length;return i?this.getRangeMsg(n,i,"checked"):!!n||this.messages.required},length:function(e,t){var i=e.value,n=(t[1]?i.replace(F,"xx"):i).length;return t&&"~"===t[0].charAt(0)&&(t[0]="0"+t[0]),this.getRangeMsg(n,t,"length",t[1]?"2_":"")},remote:function(t,i){var n,r=this,s={};return i?(n=E.exec(i[0]),s[t.name]=t.value,i[1]&&e.map(i.slice(1),function(t){s[t]=e(':input[name="'+t+'"]',r.$el).val()}),e.ajax({url:n[2],type:n[1]||"POST",data:s,cache:!1})):!0},filter:function(e,t){var i=t?RegExp("["+t[0]+"]","g"):q;return e.value=e.value.replace(i,""),!0}}),i.setTheme=function(t,i){I(t)?e.each(t,function(e,t){J[e]=t}):D(t)&&I(i)&&(J[t]=i)},i.config=function(t){e.each(t,function(e,t){"rules"===e?new n(t):"messages"===e?new r(t):B[e]=t})},e[m]=i}(jQuery);
